<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Universelle Kamera</title>
  <style>
    body{background:#000;color:#FFD700;margin:0;padding:20px;font:1.5em Arial;text-align:center}
    video,canvas{width:100%;max-width:640px;border:4px solid #FFD700;border-radius:12px}
    canvas{position:absolute;top:0;left:50%;transform:translateX(-50%)}
    #info{position:fixed;bottom:0;width:100%;background:rgba(0,0,0,0.9);padding:15px;font-size:1.4em}
    button{background:#FFD700;color:#000;padding:15px;margin:10px;border:none;border-radius:12px;font-size:1.2em}
  </style>
</head>
<body>
  <h1>Beekeeper Monitor</h1>
  <p>Kamera wird automatisch erkannt...</p>
  <video id="v" autoplay playsinline muted></video>
  <canvas id="c"></canvas>
  <div id="info">Prüfe Kamera...</div>
  <button onclick="location.reload()">Erneut versuchen</button>

  <script>
    const v = document.getElementById('v');
    const c = document.getElementById('c');
    const info = document.getElementById('info');
    const ctx = c.getContext('2d');

    // 1. Versuch: Lokale Webcam (Handy/PC)
    async function tryLocal() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({video: true});
        v.srcObject = stream;
        v.onloadedmetadata = () => {
          c.width = v.videoWidth; c.height = v.videoHeight;
          info.textContent = "Lokale Webcam aktiv – Erkennung läuft!";
          startDetection();
        };
        return true;
      } catch (e) {
        info.textContent = "Keine lokale Webcam – prüfe Netzwerk...";
        return false;
      }
    }

    // 2. Versuch: Tapo / Reolink / INSTAR (häufigste IPs scannen)
    const commonIPs = ["192.168.0.", "192.168.1.", "192.168.178.", "10.0.0."];
    const ports = [80, 554, 8000, 8080];
    let tried = 0;

    async function tryNetwork() {
      for (let base of commonIPs) {
        for (let i = 1; i < 255; i++) {
          const ip = base + i;
          tried++;
          info.textContent = `Scanne Netzwerk... (${tried}/1016)`;

          // Tapo RTSP
          const tapoUrl = `rtsp://admin:admin@${ip}:554/stream1`;
          if (await testUrl(tapoUrl)) { useCamera(tapoUrl, "Tapo gefunden!"); return; }

          // Reolink Snapshot
          const reolinkUrl = `http://${ip}/cgi-bin/api.cgi?cmd=Snap&channel=0&rs=wow&user=admin&password=admin`;
          if (await testUrl(reolinkUrl)) { useCamera(reolinkUrl, "Reolink gefunden!"); return; }

          // Raspberry Pi
          if (await testUrl(`http://${ip}:8000/video`)) { useCamera(`http://${ip}:8000/video`, "Raspberry Pi gefunden!"); return; }
        }
      }
      info.innerHTML = "Keine Kamera gefunden<br><button onclick='manualSetup()'>Manuell einrichten</button>";
    }

    async function testUrl(url) {
      try {
        const img = new Image();
        img.src = url + (url.includes('?') ? '&' : '?') + Date.now();
        await new Promise((r, rej) => { img.onload = r; img.onerror = rej; setTimeout(rej, 3000); });
        return true;
      } catch { return false; }
    }

    function useCamera(url, msg) {
      localStorage.setItem('cameraUrl', url);
      info.textContent = msg + " Erkennung läuft!";
      if (url.includes('rtsp')) v.src = url;
      else setInterval(() => { ctx.drawImage(new Image(url + '&t=' + Date.now()), 0, 0, c.width, c.height); }, 1000);
      startDetection();
    }

    function manualSetup() {
      const ip = prompt("IP-Adresse eingeben (z.B. 192.168.1.100):");
      const model = prompt("Modell (tapo/reolink/instar/hikvision):");
      let url = "";
      if (model === "tapo") url = `rtsp://admin:admin@${ip}:554/stream1`;
      if (model === "reolink") url = `http://${ip}/cgi-bin/api.cgi?cmd=Snap&channel=0&rs=wow&user=admin&password=admin`;
      if (url) { useCamera(url, "Manuell verbunden!"); }
    }

    function startDetection() {
      // Hier kommt später deine echte KI (Varroa, Hornisse, etc.)
      setInterval(() => {
        ctx.drawImage(v, 0, 0, c.width, c.height);
        ctx.strokeStyle = "#FF0000"; ctx.lineWidth = 6;
        ctx.strokeRect(100, 100, 200, 200);
        ctx.fillText("Demo-Erkennung", 110, 90);
      }, 1000);
    }

    // Start
    v.onloadedmetadata = () => { c.width = v.videoWidth; c.height = v.videoHeight; };
    tryLocal().then(success => { if (!success) tryNetwork(); });
  </script>
</body>
</html>
